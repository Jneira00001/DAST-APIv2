name: Lab Petstore API Scan

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  zap_scan:
    runs-on: ubuntu-latest
    name: Escaneo Automático con Validación
    
    steps:
      - name: Descargar Código
        uses: actions/checkout@v4

      - name: Configurar Entorno
        run: |
          mkdir -p $(pwd)/zap/wrk
          chmod 777 $(pwd)/zap/wrk

      - name: Ejecutar Escaneo Automático
        env:
          MY_TOKEN: ${{ secrets.QA_API_TOKEN }}
        run: |
          # 1. Crear el Hook de Python para automatizar el Header y el Log
          # Esto reemplaza la necesidad de un options.prop complejo para la prueba
          cat << 'EOF' > ./zap/wrk/auth_hook.py
          def sending_obj_request(zap, req):
              # Inyectamos el header programáticamente
              token = "${MY_TOKEN}"
              req.setHeader("api_key", token)
              
              # Imprimimos validación para el log de GitHub
              url = req.getRequestHeader().getURI().toString()
              print(f"!!! [AUTO-VALIDACION] Peticion enviada a: {url} | Header api_key inyectado.")
              return req
          EOF

          # 2. Inyectar el secreto real en el script de Python
          sed -i "s/\${MY_TOKEN}/$MY_TOKEN/g" ./zap/wrk/auth_hook.py

          # 3. Ejecutar ZAP contra tu Webhook
          # Usamos zap-api-scan con -t apuntando a tu link
          # Agregamos -f openapi pero forzamos el escaneo aunque falle la definicion
          docker run --rm \
            -v $(pwd)/zap/wrk:/zap/wrk:rw \
            zaproxy/zap-stable zap-api-scan.py \
            -t "https://bin.h00k.dev/d2f85f2a-3b2a-4a4e-916a-9694b82ba19d" \
            -f openapi \
            --hook=/zap/wrk/auth_hook.py \
            -r "reporte_automatizado.html" \
            -z "-config replacer.full_list(0).description=auth \
                -config replacer.full_list(0).enabled=true \
                -config replacer.full_list(0).matchtype=REQ_HEADER \
                -config replacer.full_list(0).matchstr=api_key \
                -config replacer.full_list(0).regex=false \
                -config replacer.full_list(0).replacement=$MY_TOKEN" \
            || echo "El escaneo finalizo (es normal que de error si el webhook no es una API real)."

      - name: Subir Evidencias
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Evidencia-Automatica
          path: ./zap/wrk/*
